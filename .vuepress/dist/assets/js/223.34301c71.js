(window.webpackJsonp=window.webpackJsonp||[]).push([[223],{667:function(l,c,Z){"use strict";Z.r(c);var g=Z(1),d=Object(g.a)({},(function(){var l=this,c=l._self._c;return c("ContentSlotsDistributor",{attrs:{"slot-key":l.$parent.slotKey}},[c("h1",{attrs:{id:"gas-and-fees"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#gas-and-fees"}},[l._v("#")]),l._v(" Gas and Fees")]),l._v(" "),c("p",{attrs:{synopsis:""}},[l._v("Learn about the differences between "),c("code",[l._v("Gas")]),l._v(" and "),c("code",[l._v("Fees")]),l._v(" in Ethereum and Cosmos.")]),l._v(" "),c("h2",{attrs:{id:"pre-requisite-readings"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#pre-requisite-readings"}},[l._v("#")]),l._v(" Pre-requisite Readings")]),l._v(" "),c("ul",[c("li",{attrs:{prereq:""}},[c("a",{attrs:{href:"https://docs.cosmos.network/main/basics/gas-fees.html",target:"_blank",rel:"noopener noreferrer"}},[l._v("Cosmos SDK Gas"),c("OutboundLink")],1)]),l._v(" "),c("li",{attrs:{prereq:""}},[c("a",{attrs:{href:"https://ethereum.org/en/developers/docs/gas/",target:"_blank",rel:"noopener noreferrer"}},[l._v("Ethereum Gas"),c("OutboundLink")],1)])]),l._v(" "),c("p",[l._v("The concept of Gas represents the amount of computational effort required to execute specific operations on the state machine.")]),l._v(" "),c("p",[l._v("Gas was created on Ethereum to disallow the EVM (Ethereum Virtual Machine) from running infinite\nloops by allocating a small amount of monetary value into the system. A unit of gas, usually in the\nform of a fraction of the native coin, is consumed for every operation on the EVM and requires a\nuser to pay for these operations. These operations consist in state transitions such as sending a\ntransaction or calling a contract.")]),l._v(" "),c("p",[l._v("Exactly like Ethereum, Cosmos utilizes the concept of gas and this is how Cosmos tracks the resource\nusage of operations during execution. Operations on Cosmos are represented as read or writes done to the chain's store.")]),l._v(" "),c("p",[l._v("In Cosmos, a fee is calculated and charged to the user during a message execution. This fee is\ncalculated from the sum of all gas consumed in a message execution. So, the fee is equivalent to the gas multiplied by the gas price.")]),l._v(" "),c("p",[l._v("In both networks, gas is used to make sure that operations do not require an excess amount of\ncomputational power to complete and as a way to deter bad-acting users from spamming the network.")]),l._v(" "),c("h2",{attrs:{id:"cosmos-gas"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#cosmos-gas"}},[l._v("#")]),l._v(" Cosmos "),c("code",[l._v("Gas")])]),l._v(" "),c("p",[l._v("In the Cosmos SDK, gas is tracked in the main "),c("code",[l._v("GasMeter")]),l._v(" and the "),c("code",[l._v("BlockGasMeter")]),l._v(":")]),l._v(" "),c("ul",[c("li",[c("code",[l._v("GasMeter")]),l._v(": keeps track of the gas consumed during executions that lead to state transitions. It is reset on every transaction execution.")]),l._v(" "),c("li",[c("code",[l._v("BlockGasMeter")]),l._v(": keeps track of the gas consumed in a block and enforces that the gas does not go over a predefined limit. This limit is defined in the Tendermint consensus parameters and can be changed via governance parameter change proposals.")])]),l._v(" "),c("p",[l._v("More information regarding gas in Cosmos SDK can be found "),c("a",{attrs:{href:"https://docs.cosmos.network/main/basics/gas-fees.html",target:"_blank",rel:"noopener noreferrer"}},[l._v("here"),c("OutboundLink")],1),l._v(".")]),l._v(" "),c("h2",{attrs:{id:"matching-evm-gas-consumption"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#matching-evm-gas-consumption"}},[l._v("#")]),l._v(" Matching EVM Gas consumption")]),l._v(" "),c("p",[l._v("Evmos is an EVM-compatible chain that supports Ethereum Web3 tooling. For this reason, gas\nconsumption must be equitable with other EVMs, most importantly Ethereum.")]),l._v(" "),c("p",[l._v("The main difference between EVM and Cosmos state transitions, is that the EVM uses a "),c("a",{attrs:{href:"https://github.com/ethereum/go-ethereum/blob/master/params/protocol_params.go",target:"_blank",rel:"noopener noreferrer"}},[l._v("gas table"),c("OutboundLink")],1),l._v(" for each OPCODE, whereas Cosmos uses a "),c("code",[l._v("GasConfig")]),l._v(" that charges gas for each CRUD operation by setting a flat and per-byte cost for accessing the database.")]),l._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"Ly8gR2FzQ29uZmlnIGRlZmluZXMgZ2FzIGNvc3QgZm9yIGVhY2ggb3BlcmF0aW9uIG9uIEtWU3RvcmVzCnR5cGUgR2FzQ29uZmlnIHN0cnVjdCB7CglIYXNDb3N0ICAgICAgICAgIEdhcwoJRGVsZXRlQ29zdCAgICAgICBHYXMKCVJlYWRDb3N0RmxhdCAgICAgR2FzCglSZWFkQ29zdFBlckJ5dGUgIEdhcwoJV3JpdGVDb3N0RmxhdCAgICBHYXMKCVdyaXRlQ29zdFBlckJ5dGUgR2FzCglJdGVyTmV4dENvc3RGbGF0IEdhcwp9"}})],1),l._v(" "),c("p",[l._v("In order to match the gas consumed by the EVM, the gas consumption logic from the SDK is ignored, and instead the gas consumed is calculated by subtracting the state transition leftover gas plus refund from the gas limit defined on the message.")]),l._v(" "),c("p",[l._v("To ignore the SDK gas consumption, we reset the transaction "),c("code",[l._v("GasMeter")]),l._v(" count to 0 and manually set it to the "),c("code",[l._v("gasUsed")]),l._v(" value computed by the EVM module at the end of the execution.")]),l._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSBrZWVwZXIKCmltcG9ydCAoCgkmcXVvdDttYXRoL2JpZyZxdW90OwoJJnF1b3Q7b3MmcXVvdDsKCSZxdW90O3RpbWUmcXVvdDsKCgkmcXVvdDtnaXRodWIuY29tL3BhbGFudGlyL3N0YWNrdHJhY2UmcXVvdDsKCXRtdHlwZXMgJnF1b3Q7Z2l0aHViLmNvbS90ZW5kZXJtaW50L3RlbmRlcm1pbnQvdHlwZXMmcXVvdDsKCgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3RlbGVtZXRyeSZxdW90OwoJc2RrICZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvdHlwZXMmcXVvdDsKCXNka2Vycm9ycyAmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3R5cGVzL2Vycm9ycyZxdW90OwoJYXV0aHR5cGVzICZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsveC9hdXRoL3R5cGVzJnF1b3Q7CglzdGFraW5ndHlwZXMgJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay94L3N0YWtpbmcvdHlwZXMmcXVvdDsKCglldGhlcm1pbnQgJnF1b3Q7Z2l0aHViLmNvbS90aGFyc2lzL2V0aGVybWludC90eXBlcyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS90aGFyc2lzL2V0aGVybWludC94L2V2bS90eXBlcyZxdW90OwoKCSZxdW90O2dpdGh1Yi5jb20vZXRoZXJldW0vZ28tZXRoZXJldW0vY29tbW9uJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL2NvcmUmcXVvdDsKCWV0aHR5cGVzICZxdW90O2dpdGh1Yi5jb20vZXRoZXJldW0vZ28tZXRoZXJldW0vY29yZS90eXBlcyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9jb3JlL3ZtJnF1b3Q7CgkmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL3BhcmFtcyZxdW90OwopCgovLyBOZXdFVk0gZ2VuZXJhdGVzIGEgZ28tZXRoZXJldW0gVk0gZnJvbSB0aGUgcHJvdmlkZWQgTWVzc2FnZSBmaWVsZHMgYW5kIHRoZSBjaGFpbiBwYXJhbWV0ZXJzCi8vIChDaGFpbkNvbmZpZyBhbmQgbW9kdWxlIFBhcmFtcykuIEl0IGFkZGl0aW9uYWxseSBzZXRzIHRoZSB2YWxpZGF0b3Igb3BlcmF0b3IgYWRkcmVzcyBhcyB0aGUKLy8gY29pbmJhc2UgYWRkcmVzcyB0byBtYWtlIGl0IGF2YWlsYWJsZSBmb3IgdGhlIENPSU5CQVNFIG9wY29kZSwgZXZlbiB0aG91Z2ggdGhlcmUgaXMgbm8KLy8gYmVuZWZpY2lhcnkgb2YgdGhlIGNvaW5iYXNlIHRyYW5zYWN0aW9uIChzaW5jZSB3ZSdyZSBub3QgbWluaW5nKS4KZnVuYyAoayAqS2VlcGVyKSBOZXdFVk0obXNnIGNvcmUuTWVzc2FnZSwgY29uZmlnICpwYXJhbXMuQ2hhaW5Db25maWcsIHBhcmFtcyB0eXBlcy5QYXJhbXMsIGNvaW5iYXNlIGNvbW1vbi5BZGRyZXNzKSAqdm0uRVZNIHsKCWJsb2NrQ3R4IDo9IHZtLkJsb2NrQ29udGV4dHsKCQlDYW5UcmFuc2ZlcjogY29yZS5DYW5UcmFuc2ZlciwKCQlUcmFuc2ZlcjogICAgY29yZS5UcmFuc2ZlciwKCQlHZXRIYXNoOiAgICAgay5HZXRIYXNoRm4oKSwKCQlDb2luYmFzZTogICAgY29pbmJhc2UsCgkJR2FzTGltaXQ6ICAgIGV0aGVybWludC5CbG9ja0dhc0xpbWl0KGsuY3R4KSwKCQlCbG9ja051bWJlcjogYmlnLk5ld0ludChrLmN0eC5CbG9ja0hlaWdodCgpKSwKCQlUaW1lOiAgICAgICAgYmlnLk5ld0ludChrLmN0eC5CbG9ja0hlYWRlcigpLlRpbWUuVW5peCgpKSwKCQlEaWZmaWN1bHR5OiAgYmlnLk5ld0ludCgwKSwgLy8gdW51c2VkLiBPbmx5IHJlcXVpcmVkIGluIFBvVyBjb250ZXh0Cgl9CgoJdHhDdHggOj0gY29yZS5OZXdFVk1UeENvbnRleHQobXNnKQoJdm1Db25maWcgOj0gay5WTUNvbmZpZyhwYXJhbXMpCgoJcmV0dXJuIHZtLk5ld0VWTShibG9ja0N0eCwgdHhDdHgsIGssIGNvbmZpZywgdm1Db25maWcpCn0KCi8vIFZNQ29uZmlnIGNyZWF0ZXMgYW4gRVZNIGNvbmZpZ3VyYXRpb24gZnJvbSB0aGUgZGVidWcgc2V0dGluZyBhbmQgdGhlIGV4dHJhIEVJUHMgZW5hYmxlZCBvbiB0aGUKLy8gbW9kdWxlIHBhcmFtZXRlcnMuIFRoZSBjb25maWcgZ2VuZXJhdGVkIHVzZXMgdGhlIGRlZmF1bHQgSnVtcFRhYmxlIGZyb20gdGhlIEVWTS4KZnVuYyAoayBLZWVwZXIpIFZNQ29uZmlnKHBhcmFtcyB0eXBlcy5QYXJhbXMpIHZtLkNvbmZpZyB7CglyZXR1cm4gdm0uQ29uZmlnewoJCURlYnVnOiAgICAgICBrLmRlYnVnLAoJCVRyYWNlcjogICAgICB2bS5OZXdKU09OTG9nZ2VyKCZhbXA7dm0uTG9nQ29uZmlne0RlYnVnOiBrLmRlYnVnfSwgb3MuU3RkZXJyKSwgLy8gVE9ETzogY29uc2lkZXIgdXNpbmcgdGhlIFN0cnVjdCBMb2dnZXIgdG9vCgkJTm9SZWN1cnNpb246IGZhbHNlLCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGNvbnNpZGVyIGRpc2FibGluZyByZWN1cnNpb24gdGhvdWdoIHBhcmFtcwoJCUV4dHJhRWlwczogICBwYXJhbXMuRUlQcygpLAoJfQp9CgovLyBHZXRIYXNoRm4gaW1wbGVtZW50cyB2bS5HZXRIYXNoRnVuYyBmb3IgRXRoZXJtaW50LiBJdCBoYW5kbGVzIDMgY2FzZXM6Ci8vICAxLiBUaGUgcmVxdWVzdGVkIGhlaWdodCBtYXRjaGVzIHRoZSBjdXJyZW50IGhlaWdodCBmcm9tIGNvbnRleHQgKGFuZCB0aHVzIHNhbWUgZXBvY2ggbnVtYmVyKQovLyAgMi4gVGhlIHJlcXVlc3RlZCBoZWlnaHQgaXMgZnJvbSBhbiBwcmV2aW91cyBoZWlnaHQgZnJvbSB0aGUgc2FtZSBjaGFpbiBlcG9jaAovLyAgMy4gVGhlIHJlcXVlc3RlZCBoZWlnaHQgaXMgZnJvbSBhIGhlaWdodCBncmVhdGVyIHRoYW4gdGhlIGxhdGVzdCBvbmUKZnVuYyAoayBLZWVwZXIpIEdldEhhc2hGbigpIHZtLkdldEhhc2hGdW5jIHsKCXJldHVybiBmdW5jKGhlaWdodCB1aW50NjQpIGNvbW1vbi5IYXNoIHsKCQloIDo9IGludDY0KGhlaWdodCkKCQlzd2l0Y2ggewoJCWNhc2Ugay5jdHguQmxvY2tIZWlnaHQoKSA9PSBoOgoJCQkvLyBDYXNlIDE6IFRoZSByZXF1ZXN0ZWQgaGVpZ2h0IG1hdGNoZXMgdGhlIG9uZSBmcm9tIHRoZSBjb250ZXh0IHNvIHdlIGNhbiByZXRyaWV2ZSB0aGUgaGVhZGVyCgkJCS8vIGhhc2ggZGlyZWN0bHkgZnJvbSB0aGUgY29udGV4dC4KCQkJLy8gTm90ZTogVGhlIGhlYWRlckhhc2ggaXMgb25seSBzZXQgYXQgYmVnaW4gYmxvY2ssIGl0IHdpbGwgYmUgbmlsIGluIGNhc2Ugb2YgYSBxdWVyeSBjb250ZXh0CgkJCWhlYWRlckhhc2ggOj0gay5jdHguSGVhZGVySGFzaCgpCgkJCWlmIGxlbihoZWFkZXJIYXNoKSAhPSAwIHsKCQkJCXJldHVybiBjb21tb24uQnl0ZXNUb0hhc2goaGVhZGVySGFzaCkKCQkJfQoKCQkJLy8gb25seSByZWNvbXB1dGUgdGhlIGhhc2ggaWYgbm90IHNldCAoZWc6IGNoZWNrVHhTdGF0ZSkKCQkJY29udGV4dEJsb2NrSGVhZGVyIDo9IGsuY3R4LkJsb2NrSGVhZGVyKCkKCQkJaGVhZGVyLCBlcnIgOj0gdG10eXBlcy5IZWFkZXJGcm9tUHJvdG8oJmFtcDtjb250ZXh0QmxvY2tIZWFkZXIpCgkJCWlmIGVyciAhPSBuaWwgewoJCQkJay5Mb2dnZXIoay5jdHgpLkVycm9yKCZxdW90O2ZhaWxlZCB0byBjYXN0IHRlbmRlcm1pbnQgaGVhZGVyIGZyb20gcHJvdG8mcXVvdDssICZxdW90O2Vycm9yJnF1b3Q7LCBlcnIpCgkJCQlyZXR1cm4gY29tbW9uLkhhc2h7fQoJCQl9CgoJCQloZWFkZXJIYXNoID0gaGVhZGVyLkhhc2goKQoJCQlyZXR1cm4gY29tbW9uLkJ5dGVzVG9IYXNoKGhlYWRlckhhc2gpCgoJCWNhc2Ugay5jdHguQmxvY2tIZWlnaHQoKSAmZ3Q7IGg6CgkJCS8vIENhc2UgMjogaWYgdGhlIGNoYWluIGlzIG5vdCB0aGUgY3VycmVudCBoZWlnaHQgd2UgbmVlZCB0byByZXRyaWV2ZSB0aGUgaGFzaCBmcm9tIHRoZSBzdG9yZSBmb3IgdGhlCgkJCS8vIGN1cnJlbnQgY2hhaW4gZXBvY2guIFRoaXMgb25seSBhcHBsaWVzIGlmIHRoZSBjdXJyZW50IGhlaWdodCBpcyBncmVhdGVyIHRoYW4gdGhlIHJlcXVlc3RlZCBoZWlnaHQuCgkJCWhpc3RJbmZvLCBmb3VuZCA6PSBrLnN0YWtpbmdLZWVwZXIuR2V0SGlzdG9yaWNhbEluZm8oay5jdHgsIGgpCgkJCWlmICFmb3VuZCB7CgkJCQlrLkxvZ2dlcihrLmN0eCkuRGVidWcoJnF1b3Q7aGlzdG9yaWNhbCBpbmZvIG5vdCBmb3VuZCZxdW90OywgJnF1b3Q7aGVpZ2h0JnF1b3Q7LCBoKQoJCQkJcmV0dXJuIGNvbW1vbi5IYXNoe30KCQkJfQoKCQkJaGVhZGVyLCBlcnIgOj0gdG10eXBlcy5IZWFkZXJGcm9tUHJvdG8oJmFtcDtoaXN0SW5mby5IZWFkZXIpCgkJCWlmIGVyciAhPSBuaWwgewoJCQkJay5Mb2dnZXIoay5jdHgpLkVycm9yKCZxdW90O2ZhaWxlZCB0byBjYXN0IHRlbmRlcm1pbnQgaGVhZGVyIGZyb20gcHJvdG8mcXVvdDssICZxdW90O2Vycm9yJnF1b3Q7LCBlcnIpCgkJCQlyZXR1cm4gY29tbW9uLkhhc2h7fQoJCQl9CgoJCQlyZXR1cm4gY29tbW9uLkJ5dGVzVG9IYXNoKGhlYWRlci5IYXNoKCkpCgkJZGVmYXVsdDoKCQkJLy8gQ2FzZSAzOiBoZWlnaHRzIGdyZWF0ZXIgdGhhbiB0aGUgY3VycmVudCBvbmUgcmV0dXJucyBhbiBlbXB0eSBoYXNoLgoJCQlyZXR1cm4gY29tbW9uLkhhc2h7fQoJCX0KCX0KfQoKLy8gQXBwbHlUcmFuc2FjdGlvbiBydW5zIGFuZCBhdHRlbXB0cyB0byBwZXJmb3JtIGEgc3RhdGUgdHJhbnNpdGlvbiB3aXRoIHRoZSBnaXZlbiB0cmFuc2FjdGlvbiAoaS5lIE1lc3NhZ2UpLCB0aGF0IHdpbGwKLy8gb25seSBiZSBwZXJzaXN0ZWQgKGNvbW1pdHRlZCkgdG8gdGhlIHVuZGVybHlpbmcgS1ZTdG9yZSBpZiB0aGUgdHJhbnNhY3Rpb24gZG9lcyBub3QgZmFpbC4KLy8KLy8gR2FzIHRyYWNraW5nCi8vCi8vIEV0aGVyZXVtIGNvbnN1bWVzIGdhcyBhY2NvcmRpbmcgdG8gdGhlIEVWTSBvcGNvZGVzIGluc3RlYWQgb2YgZ2VuZXJhbCByZWFkcyBhbmQgd3JpdGVzIHRvIHN0b3JlLiBCZWNhdXNlIG9mIHRoaXMsIHRoZQovLyBzdGF0ZSB0cmFuc2l0aW9uIG5lZWRzIHRvIGlnbm9yZSB0aGUgU0RLIGdhcyBjb25zdW1wdGlvbiBtZWNoYW5pc20gZGVmaW5lZCBieSB0aGUgR2FzS1ZTdG9yZSBhbmQgaW5zdGVhZCBjb25zdW1lIHRoZQovLyBhbW91bnQgb2YgZ2FzIHVzZWQgYnkgdGhlIFZNIGV4ZWN1dGlvbi4gVGhlIGFtb3VudCBvZiBnYXMgdXNlZCBpcyB0cmFja2VkIGJ5IHRoZSBFVk0gYW5kIHJldHVybmVkIGluIHRoZSBleGVjdXRpb24KLy8gcmVzdWx0LgovLwovLyBQcmlvciB0byB0aGUgZXhlY3V0aW9uLCB0aGUgc3RhcnRpbmcgdHggZ2FzIG1ldGVyIGlzIHNhdmVkIGFuZCByZXBsYWNlZCB3aXRoIGFuIGluZmluaXRlIGdhcyBtZXRlciBpbiBhIG5ldyBjb250ZXh0Ci8vIGluIG9yZGVyIHRvIGlnbm9yZSB0aGUgU0RLIGdhcyBjb25zdW1wdGlvbiBjb25maWcgdmFsdWVzIChyZWFkLCB3cml0ZSwgaGFzLCBkZWxldGUpLgovLyBBZnRlciB0aGUgZXhlY3V0aW9uLCB0aGUgZ2FzIHVzZWQgZnJvbSB0aGUgbWVzc2FnZSBleGVjdXRpb24gd2lsbCBiZSBhZGRlZCB0byB0aGUgc3RhcnRpbmcgZ2FzIGNvbnN1bWVkLCB0YWtpbmcgaW50bwovLyBjb25zaWRlcmF0aW9uIHRoZSBhbW91bnQgb2YgZ2FzIHJldHVybmVkLiBGaW5hbGx5LCB0aGUgY29udGV4dCBpcyB1cGRhdGVkIHdpdGggdGhlIEVWTSBnYXMgY29uc3VtZWQgdmFsdWUgcHJpb3IgdG8KLy8gcmV0dXJuaW5nLgovLwovLyBGb3IgcmVsZXZhbnQgZGlzY3Vzc2lvbiBzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9kaXNjdXNzaW9ucy85MDcyCmZ1bmMgKGsgKktlZXBlcikgQXBwbHlUcmFuc2FjdGlvbih0eCAqZXRodHlwZXMuVHJhbnNhY3Rpb24pICgqdHlwZXMuTXNnRXRoZXJldW1UeFJlc3BvbnNlLCBlcnJvcikgewoJZGVmZXIgdGVsZW1ldHJ5Lk1vZHVsZU1lYXN1cmVTaW5jZSh0eXBlcy5Nb2R1bGVOYW1lLCB0aW1lLk5vdygpLCB0eXBlcy5NZXRyaWNLZXlUcmFuc2l0aW9uREIpCgoJcGFyYW1zIDo9IGsuR2V0UGFyYW1zKGsuY3R4KQoJZXRoQ2ZnIDo9IHBhcmFtcy5DaGFpbkNvbmZpZy5FdGhlcmV1bUNvbmZpZyhrLmVpcDE1NUNoYWluSUQpCgoJLy8gZ2V0IHRoZSBsYXRlc3Qgc2lnbmVyIGFjY29yZGluZyB0byB0aGUgY2hhaW4gcnVsZXMgZnJvbSB0aGUgY29uZmlnCglzaWduZXIgOj0gZXRodHlwZXMuTWFrZVNpZ25lcihldGhDZmcsIGJpZy5OZXdJbnQoay5jdHguQmxvY2tIZWlnaHQoKSkpCgoJbXNnLCBlcnIgOj0gdHguQXNNZXNzYWdlKHNpZ25lcikKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YWNrdHJhY2UuUHJvcGFnYXRlKGVyciwgJnF1b3Q7ZmFpbGVkIHRvIHJldHVybiBldGhlcmV1bSB0cmFuc2FjdGlvbiBhcyBjb3JlIG1lc3NhZ2UmcXVvdDspCgl9CgoJLy8gd2UgdXNlIGEgY2FjaGVkIGNvbnRleHQgdG8gYXZvaWQgbW9kaWZ5aW5nIHRvIHN0YXRlIGluIGNhc2UgRVZNIG1zZyBpcyByZXZlcnRlZAoJY29tbWl0IDo9IGsuQmVnaW5DYWNoZWRDb250ZXh0KCkKCgkvLyBnZXQgdGhlIGNvaW5iYXNlIGFkZHJlc3MgZnJvbSB0aGUgYmxvY2sgcHJvcG9zZXIKCWNvaW5iYXNlLCBlcnIgOj0gay5HZXRDb2luYmFzZUFkZHJlc3MoKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhY2t0cmFjZS5Qcm9wYWdhdGUoZXJyLCAmcXVvdDtmYWlsZWQgdG8gb2J0YWluIGNvaW5iYXNlIGFkZHJlc3MmcXVvdDspCgl9CgoJLy8gY3JlYXRlIGFuIGV0aGVyZXVtIEVWTSBpbnN0YW5jZSBhbmQgcnVuIHRoZSBtZXNzYWdlCglldm0gOj0gay5OZXdFVk0obXNnLCBldGhDZmcsIHBhcmFtcywgY29pbmJhc2UpCgoJdHhIYXNoIDo9IHR4Lkhhc2goKQoKCS8vIHNldCB0aGUgdHJhbnNhY3Rpb24gaGFzaCBhbmQgaW5kZXggdG8gdGhlIGltcGVybWFuZW50ICh0cmFuc2llbnQpIGJsb2NrIHN0YXRlIHNvIHRoYXQgaXQncyBhbHNvCgkvLyBhdmFpbGFibGUgb24gdGhlIFN0YXRlREIgZnVuY3Rpb25zIChlZzogQWRkTG9nKQoJay5TZXRUeEhhc2hUcmFuc2llbnQodHhIYXNoKQoJay5JbmNyZWFzZVR4SW5kZXhUcmFuc2llbnQoKQoKCS8vIHBhc3MgZmFsc2UgdG8gZXhlY3V0ZSBpbiByZWFsIG1vZGUsIHdoaWNoIGRvIGFjdHVhbCBnYXMgcmVmdW5kaW5nCglyZXMsIGVyciA6PSBrLkFwcGx5TWVzc2FnZShldm0sIG1zZywgZXRoQ2ZnLCBmYWxzZSkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YWNrdHJhY2UuUHJvcGFnYXRlKGVyciwgJnF1b3Q7ZmFpbGVkIHRvIGFwcGx5IGV0aGVyZXVtIGNvcmUgbWVzc2FnZSZxdW90OykKCX0KCglyZXMuSGFzaCA9IHR4SGFzaC5IZXgoKQoJbG9ncyA6PSBrLkdldFR4TG9ncyh0eEhhc2gpCgoJLy8gQ29tbWl0IGFuZCBzd2l0Y2ggdG8gY29tbWl0dGVkIGNvbnRleHQKCWlmICFyZXMuRmFpbGVkKCkgewoJCWNvbW1pdCgpCgl9CgoJay5FbmRDYWNoZWRDb250ZXh0KCkKCgkvLyBMb2dzIG5lZWRzIHRvIGJlIGlnbm9yZWQgd2hlbiB0eCBpcyByZXZlcnRlZAoJLy8gU2V0IHRoZSBsb2cgYW5kIGJsb29tIGZpbHRlciBvbmx5IHdoZW4gdGhlIHR4IGlzIE5PVCBSRVZFUlRFRAoJaWYgIXJlcy5GYWlsZWQoKSB7CgkJcmVzLkxvZ3MgPSB0eXBlcy5OZXdMb2dzRnJvbUV0aChsb2dzKQoJCS8vIFVwZGF0ZSBibG9jayBibG9vbSBmaWx0ZXIgaW4gdGhlIG9yaWdpbmFsIGNvbnRleHQgYmVjYXVzZSBibG9ja2Jsb29tIGlzIHNldCBpbiBFbmRCbG9jawoJCWJsb29tIDo9IGsuR2V0QmxvY2tCbG9vbVRyYW5zaWVudCgpCgkJYmxvb20uT3IoYmxvb20sIGJpZy5OZXdJbnQoMCkuU2V0Qnl0ZXMoZXRodHlwZXMuTG9nc0Jsb29tKGxvZ3MpKSkKCQlrLlNldEJsb2NrQmxvb21UcmFuc2llbnQoYmxvb20pCgl9CgoJLy8gdXBkYXRlIHRoZSBnYXMgdXNlZCBhZnRlciByZWZ1bmQKCWsucmVzZXRHYXNNZXRlckFuZENvbnN1bWVHYXMocmVzLkdhc1VzZWQpCglyZXR1cm4gcmVzLCBuaWwKfQoKLy8gR2FzIGNvbnN1bXB0aW9uIG5vdGVzICh3cml0ZSBkb2MgZnJvbSB0aGlzKQoKLy8gZ2FzID0gcmVtYWluaW5nIGdhcyA9IGxpbWl0IC0gY29uc3VtZWQKCi8vIEdhcyBjb25zdW1wdGlvbiBpbiBldGhlcmV1bToKLy8gMC4gQnV5IGdhcyAtJmd0OyBkZWR1Y3QgZ2FzTGltaXQgKiBnYXNQcmljZSBmcm9tIHVzZXIgYWNjb3VudAovLyAJCTAuMSBsZWZ0b3ZlciBnYXMgPSBnYXMgbGltaXQKLy8gMS4gY29uc3VtZSBpbnRyaW5zaWMgZ2FzCi8vICAgMS4xIGxlZnRvdmVyIGdhcyA9IGxlZnRvdmVyIGdhcyAtIGludHJpbnNpYyBnYXMKLy8gMi4gRXhlYyB2bSBmdW5jdGlvbnMgYnkgcGFzc2luZyB0aGUgZ2FzIChpLmUgcmVtYWluaW5nIGdhcykKLy8gICAyLjEgZmluYWwgbGVmdG92ZXIgZ2FzIHJldHVybmVkIGFmdGVyIHNwZW5kaW5nIGdhcyBmcm9tIHRoZSBvcGNvZGVzIGp1bXAgdGFibGVzCi8vIDMuIFJlZnVuZCBhbW91bnQgPSAgbWF4KGdhc0NvbnN1bWVkIC8gMiwgZ2FzIHJlZnVuZCksIHdoZXJlIGdhcyByZWZ1bmQgaXMgYSBsb2NhbCB2YXJpYWJsZQoKLy8gVE9ETzogKEBmZWRla3VuemUpIGN1cnJlbnRseSB3ZSBjb25zdW1lIHRoZSBlbnRpcmUgZ2FzIGxpbWl0IGluIHRoZSBhbnRlIGhhbmRsZXIsIHNvIGlmIGEgdHJhbnNhY3Rpb24gZmFpbHMKLy8gdGhlIGFtb3VudCBzcGVudCB3aWxsIGJlIGdyYXRlciB0aGFuIHRoZSBnYXMgc3BlbnQgaW4gYW4gRXRoZXJldW0gdHggKGkuZSBoZXJlIHRoZSBsZWZ0b3ZlciBnYXMgd29uJ3QgYmUgcmVmdW5kZWQpLgoKLy8gQXBwbHlNZXNzYWdlIGNvbXB1dGVzIHRoZSBuZXcgc3RhdGUgYnkgYXBwbHlpbmcgdGhlIGdpdmVuIG1lc3NhZ2UgYWdhaW5zdCB0aGUgZXhpc3Rpbmcgc3RhdGUuCi8vIElmIHRoZSBtZXNzYWdlIGZhaWxzLCB0aGUgVk0gZXhlY3V0aW9uIGVycm9yIHdpdGggdGhlIHJlYXNvbiB3aWxsIGJlIHJldHVybmVkIHRvIHRoZSBjbGllbnQKLy8gYW5kIHRoZSB0cmFuc2FjdGlvbiB3b24ndCBiZSBjb21taXR0ZWQgdG8gdGhlIHN0b3JlLgovLwovLyBSZXZlcnRlZCBzdGF0ZQovLwovLyBUaGUgdHJhbnNhY3Rpb24gaXMgbmV2ZXIgJnF1b3Q7cmV2ZXJ0ZWQmcXVvdDsgc2luY2UgdGhlcmUgaXMgbm8gc25hcHNob3QgKyByb2xsYmFjayBwZXJmb3JtZWQgb24gdGhlIFN0YXRlREIuCi8vIE9ubHkgc3VjY2Vzc2Z1bCB0cmFuc2FjdGlvbnMgYXJlIHdyaXR0ZW4gdG8gdGhlIHN0b3JlIGR1cmluZyBEZWxpdmVyVHggbW9kZS4KLy8KLy8gUHJlY2hlY2tzIGFuZCBQcmVwcm9jZXNzaW5nCi8vCi8vIEFsbCByZWxldmFudCBzdGF0ZSB0cmFuc2l0aW9uIHByZWNoZWNrcyBmb3IgdGhlIE1zZ0V0aGVyZXVtVHggYXJlIHBlcmZvcm1lZCBvbiB0aGUgQW50ZUhhbmRsZXIsCi8vIHByaW9yIHRvIHJ1bm5pbmcgdGhlIHRyYW5zYWN0aW9uIGFnYWluc3QgdGhlIHN0YXRlLiBUaGUgcHJlY2hlY2tzIHJ1biBhcmUgdGhlIGZvbGxvd2luZzoKLy8KLy8gMS4gdGhlIG5vbmNlIG9mIHRoZSBtZXNzYWdlIGNhbGxlciBpcyBjb3JyZWN0Ci8vIDIuIGNhbGxlciBoYXMgZW5vdWdoIGJhbGFuY2UgdG8gY292ZXIgdHJhbnNhY3Rpb24gZmVlKGdhc2xpbWl0ICogZ2FzcHJpY2UpCi8vIDMuIHRoZSBhbW91bnQgb2YgZ2FzIHJlcXVpcmVkIGlzIGF2YWlsYWJsZSBpbiB0aGUgYmxvY2sKLy8gNC4gdGhlIHB1cmNoYXNlZCBnYXMgaXMgZW5vdWdoIHRvIGNvdmVyIGludHJpbnNpYyB1c2FnZQovLyA1LiB0aGVyZSBpcyBubyBvdmVyZmxvdyB3aGVuIGNhbGN1bGF0aW5nIGludHJpbnNpYyBnYXMKLy8gNi4gY2FsbGVyIGhhcyBlbm91Z2ggYmFsYW5jZSB0byBjb3ZlciBhc3NldCB0cmFuc2ZlciBmb3IgKip0b3Btb3N0KiogY2FsbAovLwovLyBUaGUgcHJlcHJvY2Vzc2luZyBzdGVwcyBwZXJmb3JtZWQgYnkgdGhlIEFudGVIYW5kbGVyIGFyZToKLy8KLy8gMS4gc2V0IHVwIHRoZSBpbml0aWFsIGFjY2VzcyBsaXN0IChpZmYgZm9yayAmZ3Q7IEJlcmxpbikKLy8KLy8gUXVlcnkgbW9kZQovLwovLyBUaGUgZ1JQQyBxdWVyeSBlbmRwb2ludCBmcm9tICdldGhfY2FsbCcgY2FsbHMgdGhpcyBtZXRob2QgaW4gcXVlcnkgbW9kZSwgYW5kIHNpbmNlIHRoZSBxdWVyeSBoYW5kbGVyIGRvbid0IGNhbGwgQW50ZUhhbmRsZXIsCi8vIHNvIHdlIGRvbid0IGRvIHJlYWwgZ2FzIHJlZnVuZCBpbiB0aGF0IGNhc2UuCmZ1bmMgKGsgKktlZXBlcikgQXBwbHlNZXNzYWdlKGV2bSAqdm0uRVZNLCBtc2cgY29yZS5NZXNzYWdlLCBjZmcgKnBhcmFtcy5DaGFpbkNvbmZpZywgcXVlcnkgYm9vbCkgKCp0eXBlcy5Nc2dFdGhlcmV1bVR4UmVzcG9uc2UsIGVycm9yKSB7Cgl2YXIgKAoJCXJldCAgIFtdYnl0ZSAvLyByZXR1cm4gYnl0ZXMgZnJvbSBldm0gZXhlY3V0aW9uCgkJdm1FcnIgZXJyb3IgIC8vIHZtIGVycm9ycyBkbyBub3QgZWZmZWN0IGNvbnNlbnN1cyBhbmQgYXJlIHRoZXJlZm9yZSBub3QgYXNzaWduZWQgdG8gZXJyCgkpCgoJc2VuZGVyIDo9IHZtLkFjY291bnRSZWYobXNnLkZyb20oKSkKCWNvbnRyYWN0Q3JlYXRpb24gOj0gbXNnLlRvKCkgPT0gbmlsCgoJaW50cmluc2ljR2FzLCBlcnIgOj0gay5HZXRFdGhJbnRyaW5zaWNHYXMobXNnLCBjZmcsIGNvbnRyYWN0Q3JlYXRpb24pCglpZiBlcnIgIT0gbmlsIHsKCQkvLyBzaG91bGQgaGF2ZSBhbHJlYWR5IGJlZW4gY2hlY2tlZCBvbiBBbnRlIEhhbmRsZXIKCQlyZXR1cm4gbmlsLCBzdGFja3RyYWNlLlByb3BhZ2F0ZShlcnIsICZxdW90O2ludHJpbnNpYyBnYXMgZmFpbGVkJnF1b3Q7KQoJfQoJLy8gU2hvdWxkIGNoZWNrIGFnYWluIGV2ZW4gaWYgaXQgaXMgY2hlY2tlZCBvbiBBbnRlIEhhbmRsZXIsIGJlY2F1c2UgZXRoX2NhbGwgZG9uJ3QgZ28gdGhyb3VnaCBBbnRlIEhhbmRsZXIuCglpZiBtc2cuR2FzKCkgJmx0OyBpbnRyaW5zaWNHYXMgewoJCS8vIGV0aF9lc3RpbWF0ZUdhcyB3aWxsIGNoZWNrIGZvciB0aGlzIGV4YWN0IGVycm9yCgkJcmV0dXJuIG5pbCwgc3RhY2t0cmFjZS5Qcm9wYWdhdGUoY29yZS5FcnJJbnRyaW5zaWNHYXMsICZxdW90O2FwcGx5IG1lc3NhZ2UmcXVvdDspCgl9CglsZWZ0b3ZlckdhcyA6PSBtc2cuR2FzKCkgLSBpbnRyaW5zaWNHYXMKCglpZiBjb250cmFjdENyZWF0aW9uIHsKCQlyZXQsIF8sIGxlZnRvdmVyR2FzLCB2bUVyciA9IGV2bS5DcmVhdGUoc2VuZGVyLCBtc2cuRGF0YSgpLCBsZWZ0b3ZlckdhcywgbXNnLlZhbHVlKCkpCgl9IGVsc2UgewoJCXJldCwgbGVmdG92ZXJHYXMsIHZtRXJyID0gZXZtLkNhbGwoc2VuZGVyLCAqbXNnLlRvKCksIG1zZy5EYXRhKCksIGxlZnRvdmVyR2FzLCBtc2cuVmFsdWUoKSkKCX0KCglpZiBxdWVyeSB7CgkJLy8gZ1JQQyBxdWVyeSBoYW5kbGVycyBkb24ndCBnbyB0aHJvdWdoIHRoZSBBbnRlSGFuZGxlciB0byBkZWR1Y3QgdGhlIGdhcyBmZWUgZnJvbSB0aGUgc2VuZGVyIG9yIGhhdmUgYWNjZXNzIGhpc3RvcmljYWwgc3RhdGUuCgkJLy8gV2UgZG9uJ3QgcmVmdW5kIGdhcyB0byB0aGUgc2VuZGVyLgoJCS8vIEZvciBtb3JlIGluZm8sIHNlZTogaHR0cHM6Ly9naXRodWIuY29tL3RoYXJzaXMvZXRoZXJtaW50L2lzc3Vlcy8yMjkgYW5kIGh0dHBzOi8vZ2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay9pc3N1ZXMvOTYzNgoJCWxlZnRvdmVyR2FzICs9IGsuR2FzVG9SZWZ1bmQobXNnLkdhcygpIC0gbGVmdG92ZXJHYXMpCgl9IGVsc2UgewoJCS8vIHJlZnVuZCBnYXMgcHJpb3IgdG8gaGFuZGxpbmcgdGhlIHZtIGVycm9yIGluIG9yZGVyIHRvIG1hdGNoIHRoZSBFdGhlcmV1bSBnYXMgY29uc3VtcHRpb24gaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBTREsgb25lLgoJCWxlZnRvdmVyR2FzLCBlcnIgPSBrLlJlZnVuZEdhcyhtc2csIGxlZnRvdmVyR2FzKQoJCWlmIGVyciAhPSBuaWwgewoJCQlyZXR1cm4gbmlsLCBzdGFja3RyYWNlLlByb3BhZ2F0ZShlcnIsICZxdW90O2ZhaWxlZCB0byByZWZ1bmQgZ2FzIGxlZnRvdmVyIGdhcyB0byBzZW5kZXIgJXMmcXVvdDssIG1zZy5Gcm9tKCkpCgkJfQoJfQoKCS8vIEVWTSBleGVjdXRpb24gZXJyb3IgbmVlZHMgdG8gYmUgYXZhaWxhYmxlIGZvciB0aGUgSlNPTi1SUEMgY2xpZW50Cgl2YXIgdm1FcnJvciBzdHJpbmcKCWlmIHZtRXJyICE9IG5pbCB7CgkJdm1FcnJvciA9IHZtRXJyLkVycm9yKCkKCX0KCglnYXNVc2VkIDo9IG1zZy5HYXMoKSAtIGxlZnRvdmVyR2FzCglyZXR1cm4gJmFtcDt0eXBlcy5Nc2dFdGhlcmV1bVR4UmVzcG9uc2V7CgkJR2FzVXNlZDogZ2FzVXNlZCwKCQlWbUVycm9yOiB2bUVycm9yLAoJCVJldDogICAgIHJldCwKCX0sIG5pbAp9CgovLyBHZXRFdGhJbnRyaW5zaWNHYXMgcmV0dXJucyB0aGUgaW50cmluc2ljIGdhcyBjb3N0IGZvciB0aGUgdHJhbnNhY3Rpb24KZnVuYyAoayAqS2VlcGVyKSBHZXRFdGhJbnRyaW5zaWNHYXMobXNnIGNvcmUuTWVzc2FnZSwgY2ZnICpwYXJhbXMuQ2hhaW5Db25maWcsIGlzQ29udHJhY3RDcmVhdGlvbiBib29sKSAodWludDY0LCBlcnJvcikgewoJaGVpZ2h0IDo9IGJpZy5OZXdJbnQoay5jdHguQmxvY2tIZWlnaHQoKSkKCWhvbWVzdGVhZCA6PSBjZmcuSXNIb21lc3RlYWQoaGVpZ2h0KQoJaXN0YW5idWwgOj0gY2ZnLklzSXN0YW5idWwoaGVpZ2h0KQoKCXJldHVybiBjb3JlLkludHJpbnNpY0dhcyhtc2cuRGF0YSgpLCBtc2cuQWNjZXNzTGlzdCgpLCBpc0NvbnRyYWN0Q3JlYXRpb24sIGhvbWVzdGVhZCwgaXN0YW5idWwpCn0KCi8vIEdhc1RvUmVmdW5kIGNhbGN1bGF0ZXMgdGhlIGFtb3VudCBvZiBnYXMgdGhlIHN0YXRlIG1hY2hpbmUgc2hvdWxkIHJlZnVuZCB0byB0aGUgc2VuZGVyLiBJdCBpcwovLyBjYXBwZWQgYnkgaGFsZiBvZiB0aGUgZ2FzIGNvbnN1bWVkLgpmdW5jIChrICpLZWVwZXIpIEdhc1RvUmVmdW5kKGdhc0NvbnN1bWVkIHVpbnQ2NCkgdWludDY0IHsKCS8vIEFwcGx5IHJlZnVuZCBjb3VudGVyLCBjYXBwZWQgdG8gaGFsZiBvZiB0aGUgdXNlZCBnYXMuCglyZWZ1bmQgOj0gZ2FzQ29uc3VtZWQgLyAyCglhdmFpbGFibGVSZWZ1bmQgOj0gay5HZXRSZWZ1bmQoKQoJaWYgcmVmdW5kICZndDsgYXZhaWxhYmxlUmVmdW5kIHsKCQlyZXR1cm4gYXZhaWxhYmxlUmVmdW5kCgl9CglyZXR1cm4gcmVmdW5kCn0KCi8vIFJlZnVuZEdhcyB0cmFuc2ZlcnMgdGhlIGxlZnRvdmVyIGdhcyB0byB0aGUgc2VuZGVyIG9mIHRoZSBtZXNzYWdlLCBjYXBlZCB0byBoYWxmIG9mIHRoZSB0b3RhbCBnYXMKLy8gY29uc3VtZWQgaW4gdGhlIHRyYW5zYWN0aW9uLiBBZGRpdGlvbmFsbHksIHRoZSBmdW5jdGlvbiBzZXRzIHRoZSB0b3RhbCBnYXMgY29uc3VtZWQgdG8gdGhlIHZhbHVlCi8vIHJldHVybmVkIGJ5IHRoZSBFVk0gZXhlY3V0aW9uLCB0aHVzIGlnbm9yaW5nIHRoZSBwcmV2aW91cyBpbnRyaW5zaWMgZ2FzIGNvbnN1bWVkIGR1cmluZyBpbiB0aGUKLy8gQW50ZUhhbmRsZXIuCmZ1bmMgKGsgKktlZXBlcikgUmVmdW5kR2FzKG1zZyBjb3JlLk1lc3NhZ2UsIGxlZnRvdmVyR2FzIHVpbnQ2NCkgKHVpbnQ2NCwgZXJyb3IpIHsKCS8vIHNhZmV0eSBjaGVjazogbGVmdG92ZXIgZ2FzIGFmdGVyIGV4ZWN1dGlvbiBzaG91bGQgbmV2ZXIgZXhjZWVkIHRoZSBnYXMgbGltaXQgZGVmaW5lZCBvbiB0aGUgbWVzc2FnZQoJaWYgbGVmdG92ZXJHYXMgJmd0OyBtc2cuR2FzKCkgewoJCXJldHVybiBsZWZ0b3Zlckdhcywgc3RhY2t0cmFjZS5Qcm9wYWdhdGUoCgkJCXNka2Vycm9ycy5XcmFwZih0eXBlcy5FcnJJbmNvbnNpc3RlbnRHYXMsICZxdW90O2xlZnRvdmVyIGdhcyBjYW5ub3QgYmUgZ3JlYXRlciB0aGFuIGdhcyBsaW1pdCAoJWQgJmd0OyAlZCkmcXVvdDssIGxlZnRvdmVyR2FzLCBtc2cuR2FzKCkpLAoJCQkmcXVvdDtmYWlsZWQgdG8gdXBkYXRlIGdhcyBjb25zdW1lZCBhZnRlciByZWZ1bmQgb2YgbGVmdG92ZXIgZ2FzJnF1b3Q7LAoJCSkKCX0KCglnYXNDb25zdW1lZCA6PSBtc2cuR2FzKCkgLSBsZWZ0b3ZlckdhcwoKCS8vIGNhbGN1bGF0ZSBhdmFpbGFibGUgZ2FzIHRvIHJlZnVuZCBhbmQgYWRkIGl0IHRvIHRoZSBsZWZ0b3ZlciBnYXMgYW1vdW50CglyZWZ1bmQgOj0gay5HYXNUb1JlZnVuZChnYXNDb25zdW1lZCkKCWxlZnRvdmVyR2FzICs9IHJlZnVuZAoKCS8vIHNhZmV0eSBjaGVjazogbGVmdG92ZXIgZ2FzIGFmdGVyIHJlZnVuZCBzaG91bGQgbmV2ZXIgZXhjZWVkIHRoZSBnYXMgbGltaXQgZGVmaW5lZCBvbiB0aGUgbWVzc2FnZQoJaWYgbGVmdG92ZXJHYXMgJmd0OyBtc2cuR2FzKCkgewoJCXJldHVybiBsZWZ0b3Zlckdhcywgc3RhY2t0cmFjZS5Qcm9wYWdhdGUoCgkJCXNka2Vycm9ycy5XcmFwZih0eXBlcy5FcnJJbmNvbnNpc3RlbnRHYXMsICZxdW90O2xlZnRvdmVyIGdhcyBjYW5ub3QgYmUgZ3JlYXRlciB0aGFuIGdhcyBsaW1pdCAoJWQgJmd0OyAlZCkmcXVvdDssIGxlZnRvdmVyR2FzLCBtc2cuR2FzKCkpLAoJCQkmcXVvdDtmYWlsZWQgdG8gdXBkYXRlIGdhcyBjb25zdW1lZCBhZnRlciByZWZ1bmQgb2YgJWQgZ2FzJnF1b3Q7LCByZWZ1bmQsCgkJKQoJfQoKCS8vIFJldHVybiBFVk0gdG9rZW5zIGZvciByZW1haW5pbmcgZ2FzLCBleGNoYW5nZWQgYXQgdGhlIG9yaWdpbmFsIHJhdGUuCglyZW1haW5pbmcgOj0gbmV3KGJpZy5JbnQpLk11bChuZXcoYmlnLkludCkuU2V0VWludDY0KGxlZnRvdmVyR2FzKSwgbXNnLkdhc1ByaWNlKCkpCgoJc3dpdGNoIHJlbWFpbmluZy5TaWduKCkgewoJY2FzZSAtMToKCQkvLyBuZWdhdGl2ZSByZWZ1bmQgZXJyb3JzCgkJcmV0dXJuIGxlZnRvdmVyR2FzLCBzZGtlcnJvcnMuV3JhcGYodHlwZXMuRXJySW52YWxpZFJlZnVuZCwgJnF1b3Q7cmVmdW5kZWQgYW1vdW50IHZhbHVlIGNhbm5vdCBiZSBuZWdhdGl2ZSAlZCZxdW90OywgcmVtYWluaW5nLkludDY0KCkpCgljYXNlIDE6CgkJLy8gcG9zaXRpdmUgYW1vdW50IHJlZnVuZAoJCXBhcmFtcyA6PSBrLkdldFBhcmFtcyhrLmN0eCkKCQlyZWZ1bmRlZENvaW5zIDo9IHNkay5Db2luc3tzZGsuTmV3Q29pbihwYXJhbXMuRXZtRGVub20sIHNkay5OZXdJbnRGcm9tQmlnSW50KHJlbWFpbmluZykpfQoKCQkvLyByZWZ1bmQgdG8gc2VuZGVyIGZyb20gdGhlIGZlZSBjb2xsZWN0b3IgbW9kdWxlIGFjY291bnQsIHdoaWNoIGlzIHRoZSBlc2Nyb3cgYWNjb3VudCBpbiBjaGFyZ2Ugb2YgY29sbGVjdGluZyB0eCBmZWVzCgoJCWVyciA6PSBrLmJhbmtLZWVwZXIuU2VuZENvaW5zRnJvbU1vZHVsZVRvQWNjb3VudChrLmN0eCwgYXV0aHR5cGVzLkZlZUNvbGxlY3Rvck5hbWUsIG1zZy5Gcm9tKCkuQnl0ZXMoKSwgcmVmdW5kZWRDb2lucykKCQlpZiBlcnIgIT0gbmlsIHsKCQkJZXJyID0gc2RrZXJyb3JzLldyYXBmKHNka2Vycm9ycy5FcnJJbnN1ZmZpY2llbnRGdW5kcywgJnF1b3Q7ZmVlIGNvbGxlY3RvciBhY2NvdW50IGZhaWxlZCB0byByZWZ1bmQgZmVlczogJXMmcXVvdDssIGVyci5FcnJvcigpKQoJCQlyZXR1cm4gbGVmdG92ZXJHYXMsIHN0YWNrdHJhY2UuUHJvcGFnYXRlKGVyciwgJnF1b3Q7ZmFpbGVkIHRvIHJlZnVuZCAlZCBsZWZ0b3ZlciBnYXMgKCVzKSZxdW90OywgbGVmdG92ZXJHYXMsIHJlZnVuZGVkQ29pbnMuU3RyaW5nKCkpCgkJfQoJZGVmYXVsdDoKCQkvLyBubyByZWZ1bmQsIGNvbnN1bWUgZ2FzIGFuZCB1cGRhdGUgdGhlIHR4IGdhcyBtZXRlcgoJfQoKCXJldHVybiBsZWZ0b3ZlckdhcywgbmlsCn0KCi8vIHJlc2V0R2FzTWV0ZXJBbmRDb25zdW1lR2FzIHJlc2V0IGZpcnN0IHRoZSBnYXMgbWV0ZXIgY29uc3VtZWQgdmFsdWUgdG8gemVybyBhbmQgc2V0IGl0IGJhY2sgdG8gdGhlIG5ldyB2YWx1ZQovLyAnZ2FzVXNlZCcKZnVuYyAoayAqS2VlcGVyKSByZXNldEdhc01ldGVyQW5kQ29uc3VtZUdhcyhnYXNVc2VkIHVpbnQ2NCkgewoJLy8gcmVzZXQgdGhlIGdhcyBjb3VudAoJay5jdHguR2FzTWV0ZXIoKS5SZWZ1bmRHYXMoay5jdHguR2FzTWV0ZXIoKS5HYXNDb25zdW1lZCgpLCAmcXVvdDtyZXNldCB0aGUgZ2FzIGNvdW50JnF1b3Q7KQoJay5jdHguR2FzTWV0ZXIoKS5Db25zdW1lR2FzKGdhc1VzZWQsICZxdW90O2FwcGx5IGV2bSB0cmFuc2FjdGlvbiZxdW90OykKfQoKLy8gR2V0Q29pbmJhc2VBZGRyZXNzIHJldHVybnMgdGhlIGJsb2NrIHByb3Bvc2VyJ3MgdmFsaWRhdG9yIG9wZXJhdG9yIGFkZHJlc3MuCmZ1bmMgKGsgS2VlcGVyKSBHZXRDb2luYmFzZUFkZHJlc3MoKSAoY29tbW9uLkFkZHJlc3MsIGVycm9yKSB7Cgljb25zQWRkciA6PSBzZGsuQ29uc0FkZHJlc3Moay5jdHguQmxvY2tIZWFkZXIoKS5Qcm9wb3NlckFkZHJlc3MpCgl2YWxpZGF0b3IsIGZvdW5kIDo9IGsuc3Rha2luZ0tlZXBlci5HZXRWYWxpZGF0b3JCeUNvbnNBZGRyKGsuY3R4LCBjb25zQWRkcikKCWlmICFmb3VuZCB7CgkJcmV0dXJuIGNvbW1vbi5BZGRyZXNze30sIHN0YWNrdHJhY2UuUHJvcGFnYXRlKAoJCQlzZGtlcnJvcnMuV3JhcChzdGFraW5ndHlwZXMuRXJyTm9WYWxpZGF0b3JGb3VuZCwgY29uc0FkZHIuU3RyaW5nKCkpLAoJCQkmcXVvdDtmYWlsZWQgdG8gcmV0cmlldmUgdmFsaWRhdG9yIGZyb20gYmxvY2sgcHJvcG9zZXIgYWRkcmVzcyZxdW90OywKCQkpCgl9CgoJY29pbmJhc2UgOj0gY29tbW9uLkJ5dGVzVG9BZGRyZXNzKHZhbGlkYXRvci5HZXRPcGVyYXRvcigpKQoJcmV0dXJuIGNvaW5iYXNlLCBuaWwKfQo="}})],1),l._v(" "),c("h3",{attrs:{id:"antehandler"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#antehandler"}},[l._v("#")]),l._v(" "),c("code",[l._v("AnteHandler")])]),l._v(" "),c("p",[l._v("The Cosmos SDK "),c("a",{attrs:{href:"https://docs.cosmos.network/main/basics/gas-fees.html#antehandler",target:"_blank",rel:"noopener noreferrer"}},[c("code",[l._v("AnteHandler")]),c("OutboundLink")],1),l._v("\nperforms basic checks prior to transaction execution. These checks are usually signature\nverification, transaction field validation, transaction fees, etc.")]),l._v(" "),c("p",[l._v("Regarding gas consumption and fees, the "),c("code",[l._v("AnteHandler")]),l._v(" checks that the user has enough balance to\ncover for the tx cost (amount plus fees) as well as checking that the gas limit defined in the\nmessage is greater or equal than the computed intrinsic gas for the message.")]),l._v(" "),c("h2",{attrs:{id:"gas-refunds"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#gas-refunds"}},[l._v("#")]),l._v(" Gas Refunds")]),l._v(" "),c("p",[l._v("In the EVM, gas can be specified prior to execution. The totality of the gas specified is consumed at the beginning of the execution (during the "),c("code",[l._v("AnteHandler")]),l._v(" step) and the remaining gas is refunded back to\nthe user if any gas is left over after the execution. Additionally the EVM can also define gas to be refunded back to the user but those will be capped to a fraction of the used gas depending on the fork/version being used.")]),l._v(" "),c("h2",{attrs:{id:"_0-fee-transactions"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#_0-fee-transactions"}},[l._v("#")]),l._v(" 0 Fee Transactions")]),l._v(" "),c("p",[l._v("In Cosmos, a minimum gas price is not enforced by the "),c("code",[l._v("AnteHandler")]),l._v(" as the "),c("code",[l._v("min-gas-prices")]),l._v(" is\nchecked against the local node/validator. In other words, the minimum fees accepted are determined\nby the validators of the network, and each validator can specify a different minimum value for their fees.\nThis potentially allows end users to submit 0 fee transactions if there is at least one single\nvalidator that is willing to include transactions with "),c("code",[l._v("0")]),l._v(" gas price in their blocks proposed.")]),l._v(" "),c("p",[l._v("For this same reason, in Evmos it is possible to send transactions with "),c("code",[l._v("0")]),l._v(" fees for transaction\ntypes other than the ones defined by the "),c("code",[l._v("evm")]),l._v(" module. EVM module transactions cannot have "),c("code",[l._v("0")]),l._v(" fees\nas gas is required inherently by the EVM. This check is done by the EVM transactions stateless validation\n(i.e "),c("code",[l._v("ValidateBasic")]),l._v(") function as well as on the custom "),c("code",[l._v("AnteHandler")]),l._v(" defined by Evmos.")]),l._v(" "),c("h2",{attrs:{id:"gas-estimation"}},[c("a",{staticClass:"header-anchor",attrs:{href:"#gas-estimation"}},[l._v("#")]),l._v(" Gas estimation")]),l._v(" "),c("p",[l._v("Ethereum provides a JSON-RPC endpoint "),c("code",[l._v("eth_estimateGas")]),l._v(" to help users set up a correct gas limit in their transactions.")]),l._v(" "),c("p",[l._v("Unfortunately, we cannot make use of the SDK "),c("code",[l._v("tx simulation")]),l._v(" for gas estimation because the pre-check in the Ante Handlers would require a valid signature, and the sender balance to be enough to pay for the gas. But in Ethereum, this endpoint can be called without specifying any sender address.")]),l._v(" "),c("p",[l._v("For that reason, a specific query API "),c("code",[l._v("EstimateGas")]),l._v(" is implemented in Evmos. It will apply the transaction against the current block/state and perform a binary search in order to find the optimal gas value to return to the user (the same transaction will be applied over and over until we find the minimum gas needed before it fails). The reason we need to use a binary search is that the gas required for the\ntransaction might be higher than the value returned by the EVM after applying the transaction, so we need to try until we find the optimal value.")]),l._v(" "),c("p",[l._v("A cache context will be used during the whole execution to avoid changes be persisted in the state.")]),l._v(" "),c("p",[c("tm-code-block",{staticClass:"codeblock",attrs:{language:"go",base64:"cGFja2FnZSBrZWVwZXIKCmltcG9ydCAoCgkmcXVvdDtjb250ZXh0JnF1b3Q7CgkmcXVvdDtlbmNvZGluZy9qc29uJnF1b3Q7CgkmcXVvdDtlcnJvcnMmcXVvdDsKCSZxdW90O2ZtdCZxdW90OwoKCSZxdW90O2dpdGh1Yi5jb20vcGFsYW50aXIvc3RhY2t0cmFjZSZxdW90OwoJJnF1b3Q7Z29vZ2xlLmdvbGFuZy5vcmcvZ3JwYy9jb2RlcyZxdW90OwoJJnF1b3Q7Z29vZ2xlLmdvbGFuZy5vcmcvZ3JwYy9zdGF0dXMmcXVvdDsKCgkmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3N0b3JlL3ByZWZpeCZxdW90OwoJc2RrICZxdW90O2dpdGh1Yi5jb20vY29zbW9zL2Nvc21vcy1zZGsvdHlwZXMmcXVvdDsKCXNka2Vycm9ycyAmcXVvdDtnaXRodWIuY29tL2Nvc21vcy9jb3Ntb3Mtc2RrL3R5cGVzL2Vycm9ycyZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9jb3Ntb3MvY29zbW9zLXNkay90eXBlcy9xdWVyeSZxdW90OwoKCWV0aGNtbiAmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL2NvbW1vbiZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9jb21tb24vaGV4dXRpbCZxdW90OwoJJnF1b3Q7Z2l0aHViLmNvbS9ldGhlcmV1bS9nby1ldGhlcmV1bS9jb3JlJnF1b3Q7CglldGh0eXBlcyAmcXVvdDtnaXRodWIuY29tL2V0aGVyZXVtL2dvLWV0aGVyZXVtL2NvcmUvdHlwZXMmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vZXRoZXJldW0vZ28tZXRoZXJldW0vY29yZS92bSZxdW90OwoJZXRocGFyYW1zICZxdW90O2dpdGh1Yi5jb20vZXRoZXJldW0vZ28tZXRoZXJldW0vcGFyYW1zJnF1b3Q7CgoJZXRoZXJtaW50ICZxdW90O2dpdGh1Yi5jb20vdGhhcnNpcy9ldGhlcm1pbnQvdHlwZXMmcXVvdDsKCSZxdW90O2dpdGh1Yi5jb20vdGhhcnNpcy9ldGhlcm1pbnQveC9ldm0vdHlwZXMmcXVvdDsKKQoKdmFyIF8gdHlwZXMuUXVlcnlTZXJ2ZXIgPSBLZWVwZXJ7fQoKLy8gQWNjb3VudCBpbXBsZW1lbnRzIHRoZSBRdWVyeS9BY2NvdW50IGdSUEMgbWV0aG9kCmZ1bmMgKGsgS2VlcGVyKSBBY2NvdW50KGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5QWNjb3VudFJlcXVlc3QpICgqdHlwZXMuUXVlcnlBY2NvdW50UmVzcG9uc2UsIGVycm9yKSB7CglpZiByZXEgPT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDtlbXB0eSByZXF1ZXN0JnF1b3Q7KQoJfQoKCWlmIGVyciA6PSBldGhlcm1pbnQuVmFsaWRhdGVBZGRyZXNzKHJlcS5BZGRyZXNzKTsgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKAoJCQljb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpLAoJCSkKCX0KCglhZGRyIDo9IGV0aGNtbi5IZXhUb0FkZHJlc3MocmVxLkFkZHJlc3MpCgoJY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGMpCglrLldpdGhDb250ZXh0KGN0eCkKCglyZXR1cm4gJmFtcDt0eXBlcy5RdWVyeUFjY291bnRSZXNwb25zZXsKCQlCYWxhbmNlOiAgay5HZXRCYWxhbmNlKGFkZHIpLlN0cmluZygpLAoJCUNvZGVIYXNoOiBrLkdldENvZGVIYXNoKGFkZHIpLkhleCgpLAoJCU5vbmNlOiAgICBrLkdldE5vbmNlKGFkZHIpLAoJfSwgbmlsCn0KCmZ1bmMgKGsgS2VlcGVyKSBDb3Ntb3NBY2NvdW50KGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5Q29zbW9zQWNjb3VudFJlcXVlc3QpICgqdHlwZXMuUXVlcnlDb3Ntb3NBY2NvdW50UmVzcG9uc2UsIGVycm9yKSB7CglpZiByZXEgPT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW52YWxpZEFyZ3VtZW50LCAmcXVvdDtlbXB0eSByZXF1ZXN0JnF1b3Q7KQoJfQoKCWlmIGVyciA6PSBldGhlcm1pbnQuVmFsaWRhdGVBZGRyZXNzKHJlcS5BZGRyZXNzKTsgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKAoJCQljb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpLAoJCSkKCX0KCgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCWsuV2l0aENvbnRleHQoY3R4KQoKCWV0aEFkZHIgOj0gZXRoY21uLkhleFRvQWRkcmVzcyhyZXEuQWRkcmVzcykKCWNvc21vc0FkZHIgOj0gc2RrLkFjY0FkZHJlc3MoZXRoQWRkci5CeXRlcygpKQoKCWFjY291bnQgOj0gay5hY2NvdW50S2VlcGVyLkdldEFjY291bnQoY3R4LCBjb3Ntb3NBZGRyKQoJcmVzIDo9IHR5cGVzLlF1ZXJ5Q29zbW9zQWNjb3VudFJlc3BvbnNlewoJCUNvc21vc0FkZHJlc3M6IGNvc21vc0FkZHIuU3RyaW5nKCksCgl9CgoJaWYgYWNjb3VudCAhPSBuaWwgewoJCXJlcy5TZXF1ZW5jZSA9IGFjY291bnQuR2V0U2VxdWVuY2UoKQoJCXJlcy5BY2NvdW50TnVtYmVyID0gYWNjb3VudC5HZXRBY2NvdW50TnVtYmVyKCkKCX0KCglyZXR1cm4gJmFtcDtyZXMsIG5pbAp9CgpmdW5jIChrIEtlZXBlcikgVmFsaWRhdG9yQWNjb3VudChjIGNvbnRleHQuQ29udGV4dCwgcmVxICp0eXBlcy5RdWVyeVZhbGlkYXRvckFjY291bnRSZXF1ZXN0KSAoKnR5cGVzLlF1ZXJ5VmFsaWRhdG9yQWNjb3VudFJlc3BvbnNlLCBlcnJvcikgewoJaWYgcmVxID09IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludmFsaWRBcmd1bWVudCwgJnF1b3Q7ZW1wdHkgcmVxdWVzdCZxdW90OykKCX0KCgljb25zQWRkciwgZXJyIDo9IHNkay5Db25zQWRkcmVzc0Zyb21CZWNoMzIocmVxLkNvbnNBZGRyZXNzKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKAoJCQljb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpLAoJCSkKCX0KCgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCWsuV2l0aENvbnRleHQoY3R4KQoKCXZhbGlkYXRvciwgZm91bmQgOj0gay5zdGFraW5nS2VlcGVyLkdldFZhbGlkYXRvckJ5Q29uc0FkZHIoY3R4LCBjb25zQWRkcikKCWlmICFmb3VuZCB7CgkJcmV0dXJuIG5pbCwgbmlsCgl9CgoJYWNjQWRkciA6PSBzZGsuQWNjQWRkcmVzcyh2YWxpZGF0b3IuR2V0T3BlcmF0b3IoKSkKCglyZXMgOj0gdHlwZXMuUXVlcnlWYWxpZGF0b3JBY2NvdW50UmVzcG9uc2V7CgkJQWNjb3VudEFkZHJlc3M6IGFjY0FkZHIuU3RyaW5nKCksCgl9CgoJYWNjb3VudCA6PSBrLmFjY291bnRLZWVwZXIuR2V0QWNjb3VudChjdHgsIGFjY0FkZHIpCglpZiBhY2NvdW50ICE9IG5pbCB7CgkJcmVzLlNlcXVlbmNlID0gYWNjb3VudC5HZXRTZXF1ZW5jZSgpCgkJcmVzLkFjY291bnROdW1iZXIgPSBhY2NvdW50LkdldEFjY291bnROdW1iZXIoKQoJfQoKCXJldHVybiAmYW1wO3JlcywgbmlsCgp9CgovLyBCYWxhbmNlIGltcGxlbWVudHMgdGhlIFF1ZXJ5L0JhbGFuY2UgZ1JQQyBtZXRob2QKZnVuYyAoayBLZWVwZXIpIEJhbGFuY2UoYyBjb250ZXh0LkNvbnRleHQsIHJlcSAqdHlwZXMuUXVlcnlCYWxhbmNlUmVxdWVzdCkgKCp0eXBlcy5RdWVyeUJhbGFuY2VSZXNwb25zZSwgZXJyb3IpIHsKCWlmIHJlcSA9PSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsICZxdW90O2VtcHR5IHJlcXVlc3QmcXVvdDspCgl9CgoJaWYgZXJyIDo9IGV0aGVybWludC5WYWxpZGF0ZUFkZHJlc3MocmVxLkFkZHJlc3MpOyBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoCgkJCWNvZGVzLkludmFsaWRBcmd1bWVudCwKCQkJdHlwZXMuRXJyWmVyb0FkZHJlc3MuRXJyb3IoKSwKCQkpCgl9CgoJY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGMpCglrLldpdGhDb250ZXh0KGN0eCkKCgliYWxhbmNlSW50IDo9IGsuR2V0QmFsYW5jZShldGhjbW4uSGV4VG9BZGRyZXNzKHJlcS5BZGRyZXNzKSkKCglyZXR1cm4gJmFtcDt0eXBlcy5RdWVyeUJhbGFuY2VSZXNwb25zZXsKCQlCYWxhbmNlOiBiYWxhbmNlSW50LlN0cmluZygpLAoJfSwgbmlsCn0KCi8vIFN0b3JhZ2UgaW1wbGVtZW50cyB0aGUgUXVlcnkvU3RvcmFnZSBnUlBDIG1ldGhvZApmdW5jIChrIEtlZXBlcikgU3RvcmFnZShjIGNvbnRleHQuQ29udGV4dCwgcmVxICp0eXBlcy5RdWVyeVN0b3JhZ2VSZXF1ZXN0KSAoKnR5cGVzLlF1ZXJ5U3RvcmFnZVJlc3BvbnNlLCBlcnJvcikgewoJaWYgcmVxID09IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludmFsaWRBcmd1bWVudCwgJnF1b3Q7ZW1wdHkgcmVxdWVzdCZxdW90OykKCX0KCglpZiBlcnIgOj0gZXRoZXJtaW50LlZhbGlkYXRlQWRkcmVzcyhyZXEuQWRkcmVzcyk7IGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcigKCQkJY29kZXMuSW52YWxpZEFyZ3VtZW50LAoJCQl0eXBlcy5FcnJaZXJvQWRkcmVzcy5FcnJvcigpLAoJCSkKCX0KCgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCWsuV2l0aENvbnRleHQoY3R4KQoKCWFkZHJlc3MgOj0gZXRoY21uLkhleFRvQWRkcmVzcyhyZXEuQWRkcmVzcykKCWtleSA6PSBldGhjbW4uSGV4VG9IYXNoKHJlcS5LZXkpCgoJc3RhdGUgOj0gay5HZXRTdGF0ZShhZGRyZXNzLCBrZXkpCglzdGF0ZUhleCA6PSBzdGF0ZS5IZXgoKQoKCXJldHVybiAmYW1wO3R5cGVzLlF1ZXJ5U3RvcmFnZVJlc3BvbnNlewoJCVZhbHVlOiBzdGF0ZUhleCwKCX0sIG5pbAp9CgovLyBDb2RlIGltcGxlbWVudHMgdGhlIFF1ZXJ5L0NvZGUgZ1JQQyBtZXRob2QKZnVuYyAoayBLZWVwZXIpIENvZGUoYyBjb250ZXh0LkNvbnRleHQsIHJlcSAqdHlwZXMuUXVlcnlDb2RlUmVxdWVzdCkgKCp0eXBlcy5RdWVyeUNvZGVSZXNwb25zZSwgZXJyb3IpIHsKCWlmIHJlcSA9PSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsICZxdW90O2VtcHR5IHJlcXVlc3QmcXVvdDspCgl9CgoJaWYgZXJyIDo9IGV0aGVybWludC5WYWxpZGF0ZUFkZHJlc3MocmVxLkFkZHJlc3MpOyBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoCgkJCWNvZGVzLkludmFsaWRBcmd1bWVudCwKCQkJdHlwZXMuRXJyWmVyb0FkZHJlc3MuRXJyb3IoKSwKCQkpCgl9CgoJY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGMpCglrLldpdGhDb250ZXh0KGN0eCkKCglhZGRyZXNzIDo9IGV0aGNtbi5IZXhUb0FkZHJlc3MocmVxLkFkZHJlc3MpCgljb2RlIDo9IGsuR2V0Q29kZShhZGRyZXNzKQoKCXJldHVybiAmYW1wO3R5cGVzLlF1ZXJ5Q29kZVJlc3BvbnNlewoJCUNvZGU6IGNvZGUsCgl9LCBuaWwKfQoKLy8gVHhMb2dzIGltcGxlbWVudHMgdGhlIFF1ZXJ5L1R4TG9ncyBnUlBDIG1ldGhvZApmdW5jIChrIEtlZXBlcikgVHhMb2dzKGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5VHhMb2dzUmVxdWVzdCkgKCp0eXBlcy5RdWVyeVR4TG9nc1Jlc3BvbnNlLCBlcnJvcikgewoJaWYgcmVxID09IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludmFsaWRBcmd1bWVudCwgJnF1b3Q7ZW1wdHkgcmVxdWVzdCZxdW90OykKCX0KCglpZiBldGhlcm1pbnQuSXNFbXB0eUhhc2gocmVxLkhhc2gpIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoCgkJCWNvZGVzLkludmFsaWRBcmd1bWVudCwKCQkJdHlwZXMuRXJyRW1wdHlIYXNoLkVycm9yKCksCgkJKQoJfQoKCWN0eCA6PSBzZGsuVW53cmFwU0RLQ29udGV4dChjKQoJay5XaXRoQ29udGV4dChjdHgpCgoJaGFzaCA6PSBldGhjbW4uSGV4VG9IYXNoKHJlcS5IYXNoKQoJbG9ncyA6PSBrLkdldFR4TG9ncyhoYXNoKQoKCXJldHVybiAmYW1wO3R5cGVzLlF1ZXJ5VHhMb2dzUmVzcG9uc2V7CgkJTG9nczogdHlwZXMuTmV3TG9nc0Zyb21FdGgobG9ncyksCgl9LCBuaWwKfQoKLy8gQmxvY2tMb2dzIGltcGxlbWVudHMgdGhlIFF1ZXJ5L0Jsb2NrTG9ncyBnUlBDIG1ldGhvZApmdW5jIChrIEtlZXBlcikgQmxvY2tMb2dzKGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5QmxvY2tMb2dzUmVxdWVzdCkgKCp0eXBlcy5RdWVyeUJsb2NrTG9nc1Jlc3BvbnNlLCBlcnJvcikgewoJaWYgcmVxID09IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludmFsaWRBcmd1bWVudCwgJnF1b3Q7ZW1wdHkgcmVxdWVzdCZxdW90OykKCX0KCglpZiBldGhlcm1pbnQuSXNFbXB0eUhhc2gocmVxLkhhc2gpIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoCgkJCWNvZGVzLkludmFsaWRBcmd1bWVudCwKCQkJdHlwZXMuRXJyRW1wdHlIYXNoLkVycm9yKCksCgkJKQoJfQoKCWN0eCA6PSBzZGsuVW53cmFwU0RLQ29udGV4dChjKQoKCXN0b3JlIDo9IHByZWZpeC5OZXdTdG9yZShjdHguS1ZTdG9yZShrLnN0b3JlS2V5KSwgdHlwZXMuS2V5UHJlZml4TG9ncykKCXR4TG9ncyA6PSBbXXR5cGVzLlRyYW5zYWN0aW9uTG9nc3t9CgoJcGFnZVJlcywgZXJyIDo9IHF1ZXJ5LkZpbHRlcmVkUGFnaW5hdGUoc3RvcmUsIHJlcS5QYWdpbmF0aW9uLCBmdW5jKF8sIHZhbHVlIFtdYnl0ZSwgYWNjdW11bGF0ZSBib29sKSAoYm9vbCwgZXJyb3IpIHsKCQl2YXIgdHhMb2cgdHlwZXMuVHJhbnNhY3Rpb25Mb2dzCgkJay5jZGMuTXVzdFVubWFyc2hhbCh2YWx1ZSwgJmFtcDt0eExvZykKCgkJaWYgbGVuKHR4TG9nLkxvZ3MpICZndDsgMCAmYW1wOyZhbXA7IHR4TG9nLkxvZ3NbMF0uQmxvY2tIYXNoID09IHJlcS5IYXNoIHsKCQkJaWYgYWNjdW11bGF0ZSB7CgkJCQl0eExvZ3MgPSBhcHBlbmQodHhMb2dzLCB0eExvZykKCQkJfQoJCQlyZXR1cm4gdHJ1ZSwgbmlsCgkJfQoKCQlyZXR1cm4gZmFsc2UsIG5pbAoJfSkKCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJfQoKCXJldHVybiAmYW1wO3R5cGVzLlF1ZXJ5QmxvY2tMb2dzUmVzcG9uc2V7CgkJVHhMb2dzOiAgICAgdHhMb2dzLAoJCVBhZ2luYXRpb246IHBhZ2VSZXMsCgl9LCBuaWwKfQoKLy8gQmxvY2tCbG9vbSBpbXBsZW1lbnRzIHRoZSBRdWVyeS9CbG9ja0Jsb29tIGdSUEMgbWV0aG9kCmZ1bmMgKGsgS2VlcGVyKSBCbG9ja0Jsb29tKGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLlF1ZXJ5QmxvY2tCbG9vbVJlcXVlc3QpICgqdHlwZXMuUXVlcnlCbG9ja0Jsb29tUmVzcG9uc2UsIGVycm9yKSB7CgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCglibG9vbSwgZm91bmQgOj0gay5HZXRCbG9ja0Jsb29tKGN0eCwgcmVxLkhlaWdodCkKCWlmICFmb3VuZCB7CgkJLy8gaWYgdGhlIGJsb29tIGlzIG5vdCBmb3VuZCwgcXVlcnkgdGhlIHRyYW5zaWVudCBzdG9yZSBhdCB0aGUgY3VycmVudCBoZWlnaHQKCQlrLmN0eCA9IGN0eAoJCWJsb29tSW50IDo9IGsuR2V0QmxvY2tCbG9vbVRyYW5zaWVudCgpCgoJCWlmIGJsb29tSW50LlNpZ24oKSA9PSAwIHsKCQkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKAoJCQkJY29kZXMuTm90Rm91bmQsIHNka2Vycm9ycy5XcmFwZih0eXBlcy5FcnJCbG9vbU5vdEZvdW5kLCAmcXVvdDtoZWlnaHQ6ICVkJnF1b3Q7LCByZXEuSGVpZ2h0KS5FcnJvcigpLAoJCQkpCgkJfQoKCQlibG9vbSA9IGV0aHR5cGVzLkJ5dGVzVG9CbG9vbShibG9vbUludC5CeXRlcygpKQoJfQoKCXJldHVybiAmYW1wO3R5cGVzLlF1ZXJ5QmxvY2tCbG9vbVJlc3BvbnNlewoJCUJsb29tOiBibG9vbS5CeXRlcygpLAoJfSwgbmlsCn0KCi8vIFBhcmFtcyBpbXBsZW1lbnRzIHRoZSBRdWVyeS9QYXJhbXMgZ1JQQyBtZXRob2QKZnVuYyAoayBLZWVwZXIpIFBhcmFtcyhjIGNvbnRleHQuQ29udGV4dCwgXyAqdHlwZXMuUXVlcnlQYXJhbXNSZXF1ZXN0KSAoKnR5cGVzLlF1ZXJ5UGFyYW1zUmVzcG9uc2UsIGVycm9yKSB7CgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCXBhcmFtcyA6PSBrLkdldFBhcmFtcyhjdHgpCgoJcmV0dXJuICZhbXA7dHlwZXMuUXVlcnlQYXJhbXNSZXNwb25zZXsKCQlQYXJhbXM6IHBhcmFtcywKCX0sIG5pbAp9CgovLyBTdGF0aWNDYWxsIGltcGxlbWVudHMgUXVlcnkvU3RhdGljQ2FsbCBnUlBDUCBtZXRob2QKZnVuYyAoayBLZWVwZXIpIFN0YXRpY0NhbGwoYyBjb250ZXh0LkNvbnRleHQsIHJlcSAqdHlwZXMuUXVlcnlTdGF0aWNDYWxsUmVxdWVzdCkgKCp0eXBlcy5RdWVyeVN0YXRpY0NhbGxSZXNwb25zZSwgZXJyb3IpIHsKCWlmIHJlcSA9PSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsICZxdW90O2VtcHR5IHJlcXVlc3QmcXVvdDspCgl9CgoJLy8gY3R4IDo9IHNkay5VbndyYXBTREtDb250ZXh0KGMpCgkvLyBrLldpdGhDb250ZXh0KGN0eCkKCgkvLyAvLyBwYXJzZSB0aGUgY2hhaW5JRCBmcm9tIGEgc3RyaW5nIHRvIGEgYmFzZS0xMCBpbnRlZ2VyCgkvLyBjaGFpbklERXBvY2gsIGVyciA6PSBldGhlcm1pbnQuUGFyc2VDaGFpbklEKGN0eC5DaGFpbklEKCkpCgkvLyBpZiBlcnIgIT0gbmlsIHsKCS8vIAlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJLy8gfQoKCS8vIHR4SGFzaCA6PSB0bXR5cGVzLlR4KGN0eC5UeEJ5dGVzKCkpLkhhc2goKQoJLy8gZXRoSGFzaCA6PSBldGhjbW4uQnl0ZXNUb0hhc2godHhIYXNoKQoKCS8vIHZhciByZWNpcGllbnQgKmV0aGNtbi5BZGRyZXNzCgkvLyBpZiBsZW4ocmVxLkFkZHJlc3MpICZndDsgMCB7CgkvLyAJYWRkciA6PSBldGhjbW4uSGV4VG9BZGRyZXNzKHJlcS5BZGRyZXNzKQoJLy8gCXJlY2lwaWVudCA9ICZhbXA7YWRkcgoJLy8gfQoKCS8vIHNvIDo9IGsuR2V0T3JOZXdTdGF0ZU9iamVjdCgqcmVjaXBpZW50KQoJLy8gc2VuZGVyIDo9IGV0aGNtbi5IZXhUb0FkZHJlc3MoJnF1b3Q7MHhhRGQwMDI3NUUzZDlkMjEzNjU0Q2U1MjIzZjBGQURFOGIxMDZiNzA3JnF1b3Q7KQoKCS8vIG1zZyA6PSB0eXBlcy5OZXdUeCgKCS8vIAljaGFpbklERXBvY2gsIHNvLk5vbmNlKCksIHJlY2lwaWVudCwgYmlnLk5ld0ludCgwKSwgMTAwMDAwMDAwLCBiaWcuTmV3SW50KDApLCByZXEuSW5wdXQsIG5pbCwKCS8vICkKCS8vIG1zZy5Gcm9tID0gc2VuZGVyLkhleCgpCgoJLy8gaWYgZXJyIDo9IG1zZy5WYWxpZGF0ZUJhc2ljKCk7IGVyciAhPSBuaWwgewoJLy8gCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnRlcm5hbCwgZXJyLkVycm9yKCkpCgkvLyB9CgoJLy8gZXRoTXNnLCBlcnIgOj0gbXNnLkFzTWVzc2FnZSgpCgkvLyBpZiBlcnIgIT0gbmlsIHsKCS8vIAlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJLy8gfQoKCS8vIHN0IDo9ICZhbXA7dHlwZXMuU3RhdGVUcmFuc2l0aW9uewoJLy8gCU1lc3NhZ2U6ICBldGhNc2csCgkvLyAJQ3NkYjogICAgIGsuV2l0aENvbnRleHQoY3R4KSwKCS8vIAlDaGFpbklEOiAgY2hhaW5JREVwb2NoLAoJLy8gCVR4SGFzaDogICAmYW1wO2V0aEhhc2gsCgkvLyAJU2ltdWxhdGU6IGN0eC5Jc0NoZWNrVHgoKSwKCS8vIAlEZWJ1ZzogICAgZmFsc2UsCgkvLyB9CgoJLy8gY29uZmlnLCBmb3VuZCA6PSBrLkdldENoYWluQ29uZmlnKGN0eCkKCS8vIGlmICFmb3VuZCB7CgkvLyAJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludGVybmFsLCB0eXBlcy5FcnJDaGFpbkNvbmZpZ05vdEZvdW5kLkVycm9yKCkpCgkvLyB9CgoJLy8gcmV0LCBlcnIgOj0gc3QuU3RhdGljQ2FsbChjdHgsIGNvbmZpZykKCS8vIGlmIGVyciAhPSBuaWwgewoJLy8gCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnRlcm5hbCwgZXJyLkVycm9yKCkpCgkvLyB9CgoJLy8gcmV0dXJuICZhbXA7dHlwZXMuUXVlcnlTdGF0aWNDYWxsUmVzcG9uc2V7RGF0YTogcmV0fSwgbmlsCgoJcmV0dXJuIG5pbCwgbmlsCn0KCi8vIEV0aENhbGwgaW1wbGVtZW50cyBldGhfY2FsbCBycGMgYXBpLgpmdW5jIChrIEtlZXBlcikgRXRoQ2FsbChjIGNvbnRleHQuQ29udGV4dCwgcmVxICp0eXBlcy5FdGhDYWxsUmVxdWVzdCkgKCp0eXBlcy5Nc2dFdGhlcmV1bVR4UmVzcG9uc2UsIGVycm9yKSB7CgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCWsuV2l0aENvbnRleHQoY3R4KQoKCXZhciBhcmdzIHR5cGVzLkNhbGxBcmdzCgllcnIgOj0ganNvbi5Vbm1hcnNoYWwocmVxLkFyZ3MsICZhbXA7YXJncykKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpKQoJfQoKCW1zZyA6PSBhcmdzLlRvTWVzc2FnZShyZXEuR2FzQ2FwKQoKCXBhcmFtcyA6PSBrLkdldFBhcmFtcyhjdHgpCglldGhDZmcgOj0gcGFyYW1zLkNoYWluQ29uZmlnLkV0aGVyZXVtQ29uZmlnKGsuZWlwMTU1Q2hhaW5JRCkKCgljb2luYmFzZSwgZXJyIDo9IGsuR2V0Q29pbmJhc2VBZGRyZXNzKCkKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnRlcm5hbCwgZXJyLkVycm9yKCkpCgl9CgoJZXZtIDo9IGsuTmV3RVZNKG1zZywgZXRoQ2ZnLCBwYXJhbXMsIGNvaW5iYXNlKQoJLy8gcGFzcyB0cnVlIG1lYW5zIGV4ZWN1dGUgaW4gcXVlcnkgbW9kZSwgd2hpY2ggZG9uJ3QgZG8gYWN0dWFsIGdhcyByZWZ1bmQuCglyZXMsIGVyciA6PSBrLkFwcGx5TWVzc2FnZShldm0sIG1zZywgZXRoQ2ZnLCB0cnVlKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludGVybmFsLCBlcnIuRXJyb3IoKSkKCX0KCglyZXR1cm4gcmVzLCBuaWwKfQoKLy8gRXN0aW1hdGVHYXMgaW1wbGVtZW50cyBldGhfZXN0aW1hdGVHYXMgcnBjIGFwaS4KZnVuYyAoayBLZWVwZXIpIEVzdGltYXRlR2FzKGMgY29udGV4dC5Db250ZXh0LCByZXEgKnR5cGVzLkV0aENhbGxSZXF1ZXN0KSAoKnR5cGVzLkVzdGltYXRlR2FzUmVzcG9uc2UsIGVycm9yKSB7CgljdHggOj0gc2RrLlVud3JhcFNES0NvbnRleHQoYykKCWsuV2l0aENvbnRleHQoY3R4KQoKCWlmIHJlcS5HYXNDYXAgJmx0OyBldGhwYXJhbXMuVHhHYXMgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsICZxdW90O2dhcyBjYXAgY2Fubm90IGJlIGxvd2VyIHRoYW4gMjEsMDAwJnF1b3Q7KQoJfQoKCXZhciBhcmdzIHR5cGVzLkNhbGxBcmdzCgllcnIgOj0ganNvbi5Vbm1hcnNoYWwocmVxLkFyZ3MsICZhbXA7YXJncykKCWlmIGVyciAhPSBuaWwgewoJCXJldHVybiBuaWwsIHN0YXR1cy5FcnJvcihjb2Rlcy5JbnZhbGlkQXJndW1lbnQsIGVyci5FcnJvcigpKQoJfQoKCS8vIEJpbmFyeSBzZWFyY2ggdGhlIGdhcyByZXF1aXJlbWVudCwgYXMgaXQgbWF5IGJlIGhpZ2hlciB0aGFuIHRoZSBhbW91bnQgdXNlZAoJdmFyICgKCQlsbyAgPSBldGhwYXJhbXMuVHhHYXMgLSAxCgkJaGkgIHVpbnQ2NAoJCWNhcCB1aW50NjQKCSkKCgkvLyBEZXRlcm1pbmUgdGhlIGhpZ2hlc3QgZ2FzIGxpbWl0IGNhbiBiZSB1c2VkIGR1cmluZyB0aGUgZXN0aW1hdGlvbi4KCWlmIGFyZ3MuR2FzICE9IG5pbCAmYW1wOyZhbXA7IHVpbnQ2NCgqYXJncy5HYXMpICZndDs9IGV0aHBhcmFtcy5UeEdhcyB7CgkJaGkgPSB1aW50NjQoKmFyZ3MuR2FzKQoJfSBlbHNlIHsKCQkvLyBRdWVyeSBibG9jayBnYXMgbGltaXQKCQlwYXJhbXMgOj0gY3R4LkNvbnNlbnN1c1BhcmFtcygpCgkJaWYgcGFyYW1zICE9IG5pbCAmYW1wOyZhbXA7IHBhcmFtcy5CbG9jayAhPSBuaWwgJmFtcDsmYW1wOyBwYXJhbXMuQmxvY2suTWF4R2FzICZndDsgMCB7CgkJCWhpID0gdWludDY0KHBhcmFtcy5CbG9jay5NYXhHYXMpCgkJfSBlbHNlIHsKCQkJaGkgPSByZXEuR2FzQ2FwCgkJfQoJfQoKCS8vIFRPRE8gUmVjYXAgdGhlIGhpZ2hlc3QgZ2FzIGxpbWl0IHdpdGggYWNjb3VudCdzIGF2YWlsYWJsZSBiYWxhbmNlLgoKCS8vIFJlY2FwIHRoZSBoaWdoZXN0IGdhcyBhbGxvd2FuY2Ugd2l0aCBzcGVjaWZpZWQgZ2FzY2FwLgoJaWYgcmVxLkdhc0NhcCAhPSAwICZhbXA7JmFtcDsgaGkgJmd0OyByZXEuR2FzQ2FwIHsKCQloaSA9IHJlcS5HYXNDYXAKCX0KCWNhcCA9IGhpCgoJcGFyYW1zIDo9IGsuR2V0UGFyYW1zKGN0eCkKCWV0aENmZyA6PSBwYXJhbXMuQ2hhaW5Db25maWcuRXRoZXJldW1Db25maWcoay5laXAxNTVDaGFpbklEKQoKCWNvaW5iYXNlLCBlcnIgOj0gay5HZXRDb2luYmFzZUFkZHJlc3MoKQoJaWYgZXJyICE9IG5pbCB7CgkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludGVybmFsLCBlcnIuRXJyb3IoKSkKCX0KCgkvLyBDcmVhdGUgYSBoZWxwZXIgdG8gY2hlY2sgaWYgYSBnYXMgYWxsb3dhbmNlIHJlc3VsdHMgaW4gYW4gZXhlY3V0YWJsZSB0cmFuc2FjdGlvbgoJZXhlY3V0YWJsZSA6PSBmdW5jKGdhcyB1aW50NjQpIChib29sLCAqdHlwZXMuTXNnRXRoZXJldW1UeFJlc3BvbnNlLCBlcnJvcikgewoJCWFyZ3MuR2FzID0gKCpoZXh1dGlsLlVpbnQ2NCkoJmFtcDtnYXMpCgoJCS8vIEV4ZWN1dGUgdGhlIGNhbGwgaW4gYW4gaXNvbGF0ZWQgY29udGV4dAoJCWsuQmVnaW5DYWNoZWRDb250ZXh0KCkKCgkJbXNnIDo9IGFyZ3MuVG9NZXNzYWdlKHJlcS5HYXNDYXApCgkJZXZtIDo9IGsuTmV3RVZNKG1zZywgZXRoQ2ZnLCBwYXJhbXMsIGNvaW5iYXNlKQoJCS8vIHBhc3MgdHJ1ZSBtZWFucyBleGVjdXRlIGluIHF1ZXJ5IG1vZGUsIHdoaWNoIGRvbid0IGRvIGFjdHVhbCBnYXMgcmVmdW5kLgoJCXJzcCwgZXJyIDo9IGsuQXBwbHlNZXNzYWdlKGV2bSwgbXNnLCBldGhDZmcsIHRydWUpCgoJCWsuRW5kQ2FjaGVkQ29udGV4dCgpCgoJCWlmIGVyciAhPSBuaWwgewoJCQlpZiBlcnJvcnMuSXMoc3RhY2t0cmFjZS5Sb290Q2F1c2UoZXJyKSwgY29yZS5FcnJJbnRyaW5zaWNHYXMpIHsKCQkJCXJldHVybiB0cnVlLCBuaWwsIG5pbCAvLyBTcGVjaWFsIGNhc2UsIHJhaXNlIGdhcyBsaW1pdAoJCQl9CgkJCXJldHVybiB0cnVlLCBuaWwsIGVyciAvLyBCYWlsIG91dAoJCX0KCQlyZXR1cm4gbGVuKHJzcC5WbUVycm9yKSAmZ3Q7IDAsIHJzcCwgbmlsCgl9CgoJLy8gRXhlY3V0ZSB0aGUgYmluYXJ5IHNlYXJjaCBhbmQgaG9uZSBpbiBvbiBhbiBleGVjdXRhYmxlIGdhcyBsaW1pdAoJaGksIGVyciA9IHR5cGVzLkJpblNlYXJjaChsbywgaGksIGV4ZWN1dGFibGUpCglpZiBlcnIgIT0gbmlsIHsKCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJfQoKCS8vIFJlamVjdCB0aGUgdHJhbnNhY3Rpb24gYXMgaW52YWxpZCBpZiBpdCBzdGlsbCBmYWlscyBhdCB0aGUgaGlnaGVzdCBhbGxvd2FuY2UKCWlmIGhpID09IGNhcCB7CgkJZmFpbGVkLCByZXN1bHQsIGVyciA6PSBleGVjdXRhYmxlKGhpKQoJCWlmIGVyciAhPSBuaWwgewoJCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIGVyci5FcnJvcigpKQoJCX0KCQlpZiBmYWlsZWQgewoJCQlpZiByZXN1bHQgIT0gbmlsICZhbXA7JmFtcDsgcmVzdWx0LlZtRXJyb3IgIT0gdm0uRXJyT3V0T2ZHYXMuRXJyb3IoKSB7CgkJCQlpZiByZXN1bHQuVm1FcnJvciA9PSB2bS5FcnJFeGVjdXRpb25SZXZlcnRlZC5FcnJvcigpIHsKCQkJCQlyZXR1cm4gbmlsLCB0eXBlcy5OZXdFeGVjRXJyb3JXaXRoUmVhc29uKHJlc3VsdC5SZXQpCgkJCQl9CgkJCQlyZXR1cm4gbmlsLCBzdGF0dXMuRXJyb3IoY29kZXMuSW50ZXJuYWwsIHJlc3VsdC5WbUVycm9yKQoJCQl9CgkJCS8vIE90aGVyd2lzZSwgdGhlIHNwZWNpZmllZCBnYXMgY2FwIGlzIHRvbyBsb3cKCQkJcmV0dXJuIG5pbCwgc3RhdHVzLkVycm9yKGNvZGVzLkludGVybmFsLCBmbXQuU3ByaW50ZigmcXVvdDtnYXMgcmVxdWlyZWQgZXhjZWVkcyBhbGxvd2FuY2UgKCVkKSZxdW90OywgY2FwKSkKCQl9Cgl9CglyZXR1cm4gJmFtcDt0eXBlcy5Fc3RpbWF0ZUdhc1Jlc3BvbnNle0dhczogaGl9LCBuaWwKfQo="}})],1)])}),[],!1,null,null,null);c.default=d.exports}}]);